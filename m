Return-Path: <linux-kernel+bounces-622094-lists+linux-kernel=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from ny.mirrors.kernel.org (ny.mirrors.kernel.org [147.75.199.223])
	by mail.lfdr.de (Postfix) with ESMTPS id 2DF65A9E2F4
	for <lists+linux-kernel@lfdr.de>; Sun, 27 Apr 2025 14:21:24 +0200 (CEST)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by ny.mirrors.kernel.org (Postfix) with ESMTPS id 84C3F17DF87
	for <lists+linux-kernel@lfdr.de>; Sun, 27 Apr 2025 12:21:24 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 554EB2512E4;
	Sun, 27 Apr 2025 12:21:21 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="XWQ8KECx"
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id A0AE41FFC5F;
	Sun, 27 Apr 2025 12:21:20 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1745756480; cv=none; b=WkIiChKr6npiahfnvMz2bZJk8DEsDcwIfBW8bJ7t8tipRAz8ucrm4E69fFTpNgaFBZq4jJep6a/lrpY4fKSTdmTKsxoNB6FsEXlWLs5VRzoe0q7WBzHNcy7IWfe+S/9TXjKVw44V4Zhy0ev9Jtd/o145HlZjqdXtpVWCLdpC7Sc=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1745756480; c=relaxed/simple;
	bh=qgR2lz3v3NjAxknpyrFWkaL7/bhQwLOU/tYgivfTSX4=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=qsWvA9tFWLP0TJvZr68BfRddQLFKE+hic2ON8Z27NNoINKNX3AvlYyerL3XQ0fETpS7cPz+BGGCpK9jxJq9+ojmcsbeLsZCIf/yhJkl3QT2aM4J+yThSut+PM/pnxqYU7SdyzUeSKpeH1eHY/geD3e37Zh2srGnRP4eNksN5Hfs=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=XWQ8KECx; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 1A76FC4CEE3;
	Sun, 27 Apr 2025 12:21:20 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1745756480;
	bh=qgR2lz3v3NjAxknpyrFWkaL7/bhQwLOU/tYgivfTSX4=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=XWQ8KECxSqdvcp0sL5nci/HcxJBQ9cMd8jZsZOy+5vCNBuICJhnuoSM0hN4Zvkn9o
	 ZcRXK7xE3yXvb9HbhD0i8sH3+o336Ic7QwGjMbQr5qVXf5nCgn77ELHE0N46tHlrHf
	 lfRu+4a7odTFME8AhUdMG0PGZidoWHoGd1h7YpOPkjcByZnzR3GxpU/Y2dmB6+Drz9
	 9dfzsRHXLAXP7ba/6fVX8uzDbuIgoop1wkdZHmlPX1PX1CCZm6euVKOCKOS7HmU1PB
	 gI6dHnlIYGmdmHYQ8cUsbdO1St7JLNwU6M5tI4FVsFcsY+xZJSCCpa7vwQNRKwtG/F
	 EZdL2ivuJHM0Q==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1u910X-009GIf-FL;
	Sun, 27 Apr 2025 13:21:17 +0100
Date: Sun, 27 Apr 2025 13:21:16 +0100
Message-ID: <86frhtkd6r.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: D Scott Phillips <scott@os.amperecomputing.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>,
	James Clark
 <james.clark@linaro.org>,
	James Morse <james.morse@arm.com>,
	Joey Gouly
 <joey.gouly@arm.com>,
	Kevin Brodsky <kevin.brodsky@arm.com>,
	Mark Brown
 <broonie@kernel.org>,
	Mark Rutland <mark.rutland@arm.com>,
	Oliver Upton
 <oliver.upton@linux.dev>,
	"Rob Herring (Arm)" <robh@kernel.org>,
	Shameer
 Kolothum <shameerali.kolothum.thodi@huawei.com>,
	Shiqi Liu
 <shiqiliu@hust.edu.cn>,
	Will Deacon <will@kernel.org>,
	Yicong Yang
 <yangyicong@hisilicon.com>,
	kvmarm@lists.linux.dev,
	linux-arm-kernel@lists.infradead.org,
	open list
 <linux-kernel@vger.kernel.org>
Subject: Re: [PATCH 1/2] arm64: errata: Work around AmpereOne's erratum AC03_CPU_36
In-Reply-To: <86frhx9ex6.fsf@scott-ph-mail.amperecomputing.com>
References: <20250415154711.1698544-1-scott@os.amperecomputing.com>
	<86wmbkk1yz.wl-maz@kernel.org>
	<86frhx9ex6.fsf@scott-ph-mail.amperecomputing.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: scott@os.amperecomputing.com, catalin.marinas@arm.com, james.clark@linaro.org, james.morse@arm.com, joey.gouly@arm.com, kevin.brodsky@arm.com, broonie@kernel.org, mark.rutland@arm.com, oliver.upton@linux.dev, robh@kernel.org, shameerali.kolothum.thodi@huawei.com, shiqiliu@hust.edu.cn, will@kernel.org, yangyicong@hisilicon.com, kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Fri, 25 Apr 2025 03:02:29 +0100,
D Scott Phillips <scott@os.amperecomputing.com> wrote:
> 
> Marc Zyngier <maz@kernel.org> writes:
> 
> > On Tue, 15 Apr 2025 16:47:10 +0100,
> > D Scott Phillips <scott@os.amperecomputing.com> wrote:
> >> 
> >> AC03_CPU_36 can cause asynchronous exceptions to be routed to the wrong
> >> exception level if an async exception coincides with an update to the
> >> controls for the target exception level in HCR_EL2. On affected
> >> machines, always do writes to HCR_EL2 with async exceptions blocked.
> >
> > From the actual errata document [1]:
> >
> > <quote>
> > If an Asynchronous Exception to EL2 occurs, while EL2 software is
> > changing the EL2 exception control bits from a configuration where
> > asynchronous exceptions are routed to EL2 to a configuration where
> > asynchronous exceptions are routed to EL1, the processor may exhibit
> > the incorrect exception behavior of routing an interrupt taken at EL2
> > to EL1.  The affected system register is HCR_EL2, which contains
> > control bits for routing and enabling of EL2 exceptions.
> > </quote>
> >
> > My reading is that things can go wrong when clearing the xMO bits.
> >
> > I don't think we need to touch the xMO bits at all when running
> > VHE. So my preference would be to:
> >
> > - simply leave the xMO bits set at all times (nothing bad can happen
> >   from that, can it?)
> >
> > - prevent these systems from using anything but VHE (and fail KVM init
> >   otherwise)
> 
> Hi Marc, I started writing up this patch and then realized that the
> issue can also not happen in nvhe mode. While xMO bits are modified
> there, async exceptions are always masked and so the "simultaneously
> take an async exception" part of the erratum can't happen.
> 
> Does that sound right to you, or are there cases that I'm missing. If
> it's right the nvhe is also can't hit the erratum case, then what do you
> think is the right thing for me to do here?

That's an interesting point. We always run the nVHE/hVHE hypervisor
code with interrupts disabled by virtue of taking an HVC exception
into EL2, so that particular case seems OK as it literally implements
the proposed workaround.

However, there's at least one catch: the SError handling code in
hyp/entry.S relies on clearing PSTATE.A to take a pending abort (the
so-called VAXorcism). I take that this CPU implements FEAT_RAS, and
that we don't need to worry about this code path either, and that the
erratum cannot trigger on speculatively executed paths?

If we're OK with that, then I don't think there is much to do, other
than always setting the xMO bits at all times, for which I already
have a patch in review (v2 coming shortly).

	M.

-- 
Without deviation from the norm, progress is not possible.

