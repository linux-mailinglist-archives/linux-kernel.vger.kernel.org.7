Return-Path: <linux-kernel+bounces-606647-lists+linux-kernel=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from ny.mirrors.kernel.org (ny.mirrors.kernel.org [147.75.199.223])
	by mail.lfdr.de (Postfix) with ESMTPS id 9C279A8B1D4
	for <lists+linux-kernel@lfdr.de>; Wed, 16 Apr 2025 09:19:45 +0200 (CEST)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by ny.mirrors.kernel.org (Postfix) with ESMTPS id A385C17AA59
	for <lists+linux-kernel@lfdr.de>; Wed, 16 Apr 2025 07:19:45 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 669091DF260;
	Wed, 16 Apr 2025 07:19:36 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="YIM+gkhj"
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C54DA24B34;
	Wed, 16 Apr 2025 07:19:35 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1744787975; cv=none; b=up9KdESU+dUKMt4Q9hT21515urYW010D7GhFwL4ucL+5kx+6075krOtSs6uyTntl4Q5UgEBLL8iwq3CRN1FXrS+VDM1VjSTuAT02wPG+zXoUaHTT9qfxVtBZ1isZ1Dx+8Cbxm/HyaWN+lKB8635sj/467BdIphWtREmudZUe1y0=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1744787975; c=relaxed/simple;
	bh=L1F0iz+mGjxASpELFwE+TVnNzquaENAnd+uAheImZyI=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=HMdu4nb4wW2MX+GF6q+5rTtKkHmR7Sq7dSFvOVkQmzLxNQDA6Avp55xFLz5L2HD4uUdI9hE7mNyqTNI9QFNyvkVorDHkBzSUyyQAE43g6U+leSPmwqURKEF96gEbd7j9DfcBg0oEuY+ItCHw1QksGa1A7uZbzHlSi8oF5WztvAs=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=YIM+gkhj; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 35CFFC4CEE2;
	Wed, 16 Apr 2025 07:19:35 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1744787975;
	bh=L1F0iz+mGjxASpELFwE+TVnNzquaENAnd+uAheImZyI=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=YIM+gkhjyg2/4XI5rQHG5SaZj/eHH3qjAJvtu59bFvDiJ5jOD4cVTw8xhKKgoM2n8
	 mqU4j5lNhXhVaCootafp45UIFJJdKIi6u/Yw7NPVph2C9mjWY0RtUlTmZU/qHGC3jt
	 8TiPsv6u1Nz6Is2jhMUMQYegEcXn6nyHUeBBHuDY6/w9V99lBiovQ40ADkzabqyCKE
	 8wVJRCzd4RBWQuYWeaDLq8Mt/7KHJU0ZG3hdT94FoEsty4mSgLyGPIH4sCmUlW4+Wz
	 SeVemhXMb75PioKUWRTJ81/kRdt+o3UO+VfOqzHudewXiEumpT0NdDNFdY/ldHFh27
	 bw99kCoj38/lQ==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1u4x3U-005wvK-S8;
	Wed, 16 Apr 2025 08:19:32 +0100
Date: Wed, 16 Apr 2025 08:19:32 +0100
Message-ID: <86wmbkk1yz.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: D Scott Phillips <scott@os.amperecomputing.com>
Cc: Catalin Marinas <catalin.marinas@arm.com>,
	James Clark <james.clark@linaro.org>,
	James Morse <james.morse@arm.com>,
	Joey Gouly <joey.gouly@arm.com>,
	Kevin Brodsky <kevin.brodsky@arm.com>,
	Mark Brown <broonie@kernel.org>,
	Mark Rutland <mark.rutland@arm.com>,
	Oliver Upton <oliver.upton@linux.dev>,
	"Rob Herring (Arm)" <robh@kernel.org>,
	Shameer Kolothum <shameerali.kolothum.thodi@huawei.com>,
	Shiqi Liu <shiqiliu@hust.edu.cn>,
	Will Deacon <will@kernel.org>,
	Yicong Yang <yangyicong@hisilicon.com>,
	kvmarm@lists.linux.dev,
	linux-arm-kernel@lists.infradead.org,
	linux-kernel@vger.kernel.org (open list)
Subject: Re: [PATCH 1/2] arm64: errata: Work around AmpereOne's erratum AC03_CPU_36
In-Reply-To: <20250415154711.1698544-1-scott@os.amperecomputing.com>
References: <20250415154711.1698544-1-scott@os.amperecomputing.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: quoted-printable
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: scott@os.amperecomputing.com, catalin.marinas@arm.com, james.clark@linaro.org, james.morse@arm.com, joey.gouly@arm.com, kevin.brodsky@arm.com, broonie@kernel.org, mark.rutland@arm.com, oliver.upton@linux.dev, robh@kernel.org, shameerali.kolothum.thodi@huawei.com, shiqiliu@hust.edu.cn, will@kernel.org, yangyicong@hisilicon.com, kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Tue, 15 Apr 2025 16:47:10 +0100,
D Scott Phillips <scott@os.amperecomputing.com> wrote:
>=20
> AC03_CPU_36 can cause asynchronous exceptions to be routed to the wrong
> exception level if an async exception coincides with an update to the
> controls for the target exception level in HCR_EL2. On affected
> machines, always do writes to HCR_EL2 with async exceptions blocked.

=46rom the actual errata document [1]:

<quote>
If an Asynchronous Exception to EL2 occurs, while EL2 software is
changing the EL2 exception control bits from a configuration where
asynchronous exceptions are routed to EL2 to a configuration where
asynchronous exceptions are routed to EL1, the processor may exhibit
the incorrect exception behavior of routing an interrupt taken at EL2
to EL1.  The affected system register is HCR_EL2, which contains
control bits for routing and enabling of EL2 exceptions.
</quote>

My reading is that things can go wrong when clearing the xMO bits.

I don't think we need to touch the xMO bits at all when running
VHE. So my preference would be to:

- simply leave the xMO bits set at all times (nothing bad can happen
  from that, can it?)

- prevent these systems from using anything but VHE (and fail KVM init
  otherwise)

This would save a lot of maintenance hassle and the extreme ugliness
of this patch.

Thanks,

	M.

[1] https://amperecomputing.com/assets/AmpereOne_Developer_ER_v0_80_2024082=
3_28945022f4.pdf

--=20
Without deviation from the norm, progress is not possible.

