Return-Path: <linux-kernel+bounces-751744-lists+linux-kernel=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [139.178.88.99])
	by mail.lfdr.de (Postfix) with ESMTPS id EEC1EB16CF4
	for <lists+linux-kernel@lfdr.de>; Thu, 31 Jul 2025 09:57:08 +0200 (CEST)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id 89C213AF94E
	for <lists+linux-kernel@lfdr.de>; Thu, 31 Jul 2025 07:56:38 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 339D029DB81;
	Thu, 31 Jul 2025 07:57:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="UkGAA0yj"
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 8D8A41EDA2F;
	Thu, 31 Jul 2025 07:57:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1753948622; cv=none; b=Z270+Vy4wLojGjQ19ucFmlt4juWptX0nS1Aeiv4wVzdCn8iNYzj9YGAxDCA45ki1xVgUxwW1MIrXpd16uk/TFHe9jv5mYqjGIwbc0E1L0jMtJOR02s6xVDKm9QS24x4+QbHHPnAUz4WIr1nMF16VExE26xcnMbnqxDMGCDyBwLM=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1753948622; c=relaxed/simple;
	bh=61dcSPYpfvv/XWFpt2pjSx2eN1l00uIV5kw223T8ITM=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=fszLJw/APLz1u4htzsJNB6eEtqGALeQ3efjEZ0typRix4I/vcVmiGkAdgvgEeoSj6O4ENRiriOX+GezqKMKyC/eQ1PsC9P8N3aToNPNXu+RVqNcb7uXxJa1V+tg57cBRs+qEMwvk98davYyErnHucGYGz10N7IMxNbXsF1P/wo0=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=UkGAA0yj; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 6C042C4CEEF;
	Thu, 31 Jul 2025 07:57:02 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1753948622;
	bh=61dcSPYpfvv/XWFpt2pjSx2eN1l00uIV5kw223T8ITM=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=UkGAA0yj/3k/okEA7kxXkDaNLmJ5M9UWEjRsfbaWOr7vtLQUNzzMu0Eu/B7+fnIo/
	 KLjrBa1BRvI2W56uH8/STvBEi+/IASgDPRKiAVKiIaW7sakZyL80biAxOpCTn4CYYU
	 O3C6L8IIpbmsKLoJvcJqdXevXEMCwy5PLgxPU5wiK6PkUAdtt85m0mALeHO+TCrki4
	 RM0bZmtpqMVj7LMFnBcdN4Wv2qaP4hhQ8JosZnkOnLiThkOUTkV2uHSat0trox9HTo
	 GMlCHV4PkolOUr1n4kJJAnveLs+ks5EWH+5tlHPTELoQNRuXoL18UI/FIv4jVohmGt
	 oEFmuJcfXLTUQ==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1uhO9r-002qnd-VE;
	Thu, 31 Jul 2025 08:57:00 +0100
Date: Thu, 31 Jul 2025 08:56:59 +0100
Message-ID: <86zfck7pys.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Will Deacon <will@kernel.org>
Cc: perlarsen@google.com,
	Oliver Upton <oliver.upton@linux.dev>,
	Joey Gouly <joey.gouly@arm.com>,
	Suzuki K Poulose <suzuki.poulose@arm.com>,
	Zenghui Yu <yuzenghui@huawei.com>,
	Catalin Marinas <catalin.marinas@arm.com>,
	Sudeep Holla <sudeep.holla@arm.com>,
	linux-arm-kernel@lists.infradead.org,
	kvmarm@lists.linux.dev,
	linux-kernel@vger.kernel.org,
	ahomescu@google.com,
	armellel@google.com,
	arve@android.com,
	ayrton@google.com,
	qperret@google.com,
	sebastianene@google.com,
	qwandor@google.com
Subject: Re: [PATCH v7 4/5] KVM: arm64: Bump the supported version of FF-A to 1.2
In-Reply-To: <aHpP7fntDQ7SMPAC@willie-the-truck>
References: <20250701-virtio-msg-ffa-v7-0-995afc3d385e@google.com>
	<20250701-virtio-msg-ffa-v7-4-995afc3d385e@google.com>
	<aHpP7fntDQ7SMPAC@willie-the-truck>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/30.1
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: linux-kernel@vger.kernel.org
List-Id: <linux-kernel.vger.kernel.org>
List-Subscribe: <mailto:linux-kernel+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-kernel+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: will@kernel.org, perlarsen@google.com, oliver.upton@linux.dev, joey.gouly@arm.com, suzuki.poulose@arm.com, yuzenghui@huawei.com, catalin.marinas@arm.com, sudeep.holla@arm.com, linux-arm-kernel@lists.infradead.org, kvmarm@lists.linux.dev, linux-kernel@vger.kernel.org, ahomescu@google.com, armellel@google.com, arve@android.com, ayrton@google.com, qperret@google.com, sebastianene@google.com, qwandor@google.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Fri, 18 Jul 2025 14:45:17 +0100,
Will Deacon <will@kernel.org> wrote:
> 
> On Tue, Jul 01, 2025 at 10:06:37PM +0000, Per Larsen via B4 Relay wrote:
> > From: Per Larsen <perlarsen@google.com>
> > 
> > FF-A version 1.2 introduces the DIRECT_REQ2 ABI. Bump the FF-A version
> > preferred by the hypervisor as a precursor to implementing the 1.2-only
> > FFA_MSG_SEND_DIRECT_REQ2 and FFA_MSG_SEND_RESP2 messaging interfaces.
> > 
> > We must also use SMCCC 1.2 for 64-bit SMCs if hypervisor negotiated FF-A
> > 1.2, so ffa_set_retval is updated and a new function to call 64-bit smcs
> > using SMCCC 1.2 with fallback to SMCCC 1.1 is introduced.
> > 
> > Update ffa_call_supported to mark FF-A 1.2 interfaces as unsupported
> > lest they get forwarded.
> > 
> > Co-developed-by: Ayrton Munoz <ayrton@google.com>
> > Signed-off-by: Ayrton Munoz <ayrton@google.com>
> > Signed-off-by: Per Larsen <perlarsen@google.com>
> > ---
> >  arch/arm64/kvm/hyp/nvhe/ffa.c | 18 ++++++++++++++----
> >  include/linux/arm_ffa.h       |  1 +
> >  2 files changed, 15 insertions(+), 4 deletions(-)
>

[..]

Late catching up on this, as we seem to get a version a day, probably
in the hope that it will keep *something* away,...

> > @@ -734,7 +741,10 @@ static int hyp_ffa_post_init(void)
> >  	if (res.a0 != FFA_SUCCESS)
> >  		return -EOPNOTSUPP;
> >  
> > -	switch (res.a2) {
> > +	if ((res.a2 & GENMASK(15, 2)) != 0 || res.a3 != 0)
> > +		return -EINVAL;
> 
> Why are you checking bits a2[15:2] and a3? The spec says they MBZ,
> so we shouldn't care about enforcing that. In fact, adding the check
> probably means we'll fail if those bits get allocated in future.

I have the exact opposite approach. If we don't check that they are 0
for v1.2 and previous versions, we won't be able to tell what they
mean when they are finally allocated to mean something in version
1.337.

Until we support such version, MBZ should be enforced, because we
otherwise don't understand what the "client" is trying to say. And we
don't understand, we're guaranteed to do the wrong thing.

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.

